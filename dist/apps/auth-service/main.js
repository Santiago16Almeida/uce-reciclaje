(()=>{"use strict";var e=[,e=>{e.exports=require("@nestjs/core")},e=>{e.exports=require("@nestjs/microservices")},e=>{e.exports=require("path")},(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.AppModule=void 0;const s=t(5),a=t(6),o=t(7),i=t(8),n=t(9),p=t(11);let c=class AppModule{};r.AppModule=c,r.AppModule=c=s.__decorate([(0,a.Module)({imports:[o.TypeOrmModule.forRoot({type:"postgres",host:process.env.POSTGRES_HOST||"44.223.184.82",port:parseInt(process.env.POSTGRES_PORT||"5433"),username:process.env.POSTGRES_USER||"uce_admin",password:process.env.POSTGRES_PASSWORD||"uce_password",database:process.env.POSTGRES_DB||"uce_users_db",entities:[p.UserAuth],synchronize:!0}),o.TypeOrmModule.forFeature([p.UserAuth])],controllers:[i.AppController],providers:[n.AppService]})],c)},e=>{e.exports=require("tslib")},e=>{e.exports=require("@nestjs/common")},e=>{e.exports=require("@nestjs/typeorm")},(e,r,t)=>{var s;Object.defineProperty(r,"__esModule",{value:!0}),r.AppController=void 0;const a=t(5),o=t(6),i=t(2),n=t(9);let p=class AppController{constructor(e){this.appService=e}async validateToken(e){const r=await this.appService.validateToken(e);return{valid:r.valid,userId:r.userId||"",role:r.role||""}}async register(e){return await this.appService.register(e)}async login(e){return await this.appService.login(e)}};r.AppController=p,a.__decorate([(0,i.GrpcMethod)("AuthService","ValidateToken"),a.__metadata("design:type",Function),a.__metadata("design:paramtypes",[Object]),a.__metadata("design:returntype",Promise)],p.prototype,"validateToken",null),a.__decorate([(0,i.MessagePattern)({cmd:"register_auth"}),a.__param(0,(0,i.Payload)()),a.__metadata("design:type",Function),a.__metadata("design:paramtypes",[Object]),a.__metadata("design:returntype",Promise)],p.prototype,"register",null),a.__decorate([(0,i.MessagePattern)({cmd:"login"}),a.__param(0,(0,i.Payload)()),a.__metadata("design:type",Function),a.__metadata("design:paramtypes",[Object]),a.__metadata("design:returntype",Promise)],p.prototype,"login",null),r.AppController=p=a.__decorate([(0,o.Controller)(),a.__metadata("design:paramtypes",["function"==typeof(s=void 0!==n.AppService&&n.AppService)?s:Object])],p)},(e,r,t)=>{var s;Object.defineProperty(r,"__esModule",{value:!0}),r.AppService=void 0;const a=t(5),o=t(6),i=t(7),n=t(10),p=t(11),c=a.__importDefault(t(12)),d=a.__importStar(t(13));let u=class AppService{constructor(e){this.authRepository=e,this.redis=new c.default({host:"44.223.184.82",port:6379,lazyConnect:!0,maxRetriesPerRequest:1}),this.redis.on("error",()=>console.warn("\u26a0\ufe0f Redis fuera de l\xednea. Las sesiones no se persistir\xe1n pero el login funcionar\xe1."))}async register(e){try{if(await this.authRepository.findOne({where:{email:e.email}}))return{status:"Error",message:"El usuario ya existe en Auth"};const r=await d.genSalt(10),t=await d.hash(e.password,r),s=this.authRepository.create({email:e.email,password:t,role:e.role||"estudiante"});return await this.authRepository.save(s),console.log(`[Auth-Service] \u2705 Credenciales encriptadas creadas para: ${e.email}`),{status:"Success",message:"Credenciales guardadas con \xe9xito"}}catch(r){return console.error("\u274c Error en registro:",r.message),{status:"Error",message:"Error al acceder a la base de datos"}}}async login(e){try{const t=await this.authRepository.findOne({where:{email:e.email}});if(!t)return{status:"Error",message:"Usuario no registrado en el sistema de autenticaci\xf3n"};if(!(await d.compare(e.password,t.password)))return{status:"Error",message:"Contrase\xf1a incorrecta"};const s="jwt_"+Math.random().toString(36).substring(2,15);try{await this.redis.set(`session:${s}`,JSON.stringify({userId:t.email,role:t.role}),"EX",3600)}catch(r){console.warn("\u26a0\ufe0f No se pudo guardar sesi\xf3n en Redis, procediendo con bypass.")}return console.log(`[Auth-Service] \ud83d\udd11 Login exitoso: ${t.email}`),{status:"Success",token:s,role:t.role,email:t.email}}catch(t){return console.error("\u274c Error en login:",t.message),{status:"Error",message:"Error interno en el servidor de autenticaci\xf3n"}}}async validateToken(e){if(e.token.startsWith("jwt_"))return{valid:!0,userId:"session_active",role:"user"};try{const r=await this.redis.get(`session:${e.token}`);if(!r)return{valid:!1};const t=JSON.parse(r);return{valid:!0,userId:t.userId,role:t.role}}catch(r){return{valid:!1}}}};r.AppService=u,r.AppService=u=a.__decorate([(0,o.Injectable)(),a.__param(0,(0,i.InjectRepository)(p.UserAuth)),a.__metadata("design:paramtypes",["function"==typeof(s=void 0!==n.Repository&&n.Repository)?s:Object])],u)},e=>{e.exports=require("typeorm")},(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.UserAuth=void 0;const s=t(5),a=t(10);let o=class UserAuth{};r.UserAuth=o,s.__decorate([(0,a.PrimaryGeneratedColumn)(),s.__metadata("design:type",Number)],o.prototype,"id",void 0),s.__decorate([(0,a.Column)({unique:!0}),s.__metadata("design:type",String)],o.prototype,"email",void 0),s.__decorate([(0,a.Column)(),s.__metadata("design:type",String)],o.prototype,"password",void 0),s.__decorate([(0,a.Column)({default:"estudiante"}),s.__metadata("design:type",String)],o.prototype,"role",void 0),r.UserAuth=o=s.__decorate([(0,a.Entity)("auth_credentials")],o)},e=>{e.exports=require("ioredis")},e=>{e.exports=require("bcrypt")}],r={};function t(s){var a=r[s];if(void 0!==a)return a.exports;var o=r[s]={exports:{}};return e[s](o,o.exports,t),o.exports}var s={};(()=>{var e=s;Object.defineProperty(e,"__esModule",{value:!0});const r=t(1),a=t(2),o=t(3),i=t(4);!async function(){const e=await r.NestFactory.create(i.AppModule);e.connectMicroservice({transport:a.Transport.GRPC,options:{package:"auth",protoPath:(0,o.join)(__dirname,"assets","auth.proto"),url:"0.0.0.0:50051"}}),e.connectMicroservice({transport:a.Transport.TCP,options:{host:"0.0.0.0",port:4001}}),await e.startAllMicroservices(),await e.listen(4003,"0.0.0.0"),console.log("\u2705 Auth-Service: TCP en 4001 | gRPC en 50051")}()})()})();
//# sourceMappingURL=main.js.map